<!DOCTYPE html>
<html>

<head>
    <script src="scripts//web3/dist/web3.js"></script>
    <script src="scripts/jquery/dist/jquery.js"></script>
    <script>
    web3 = new Web3();
    web3.setProvider(new web3.providers.HttpProvider("http://localhost:8454"));
    var accounts = web3.eth.accounts;
    web3.eth.defaultAccount = web3.eth.coinbase; // nicht vergessen sonst invalid address error
    console.log(accounts);
    var datafeedContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"reqID","type":"bytes32"},{"name":"price","type":"uint256"}],"name":"sendPrice","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"id","type":"address"},{"name":"symbol","type":"bytes32"}],"name":"askForPrice","outputs":[{"name":"result","type":"bytes32"}],"type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address"}],"name":"setDSX","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"dSX","outputs":[{"name":"","type":"address"}],"type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"id","type":"bytes32"},{"indexed":false,"name":"symbol","type":"bytes32"}],"name":"askForPriceEvent","type":"event"}]);
    var datafeed = datafeedContract.at("0x5efd655c794cc5c80fdc7bb880c33803d7c1c492");

    </script>
</head>
<body>
  <h1>Price Retriever  </h1>
  <h2>pushes financial data into the ethereum ecosystem ... </h2>
<script>
    var tokenSymbolraw;
    var tokenSymbol;
    var askForPriceEvent = datafeed.askForPriceEvent();
    var price;
    askForPriceEvent.watch(function(e, r) {
                if (!e) {
                    console.log("In askForPriceEvent: symbol: " + web3.toAscii(r.args.symbol));
                    console.log("In askForPriceEvent: address: " + r.args.id);
                    tokenSymbolraw = r.args.symbol;
                    tokenSymbol = web3.toAscii(r.args.symbol).toString();
                    id = r.args.id;

                    if (tokenSymbolraw == "0x4554485553440000000000000000000000000000000000000000000000000000") { // ascii bytes32 darstellung von ETHUSD
                        $.getJSON("https://bity.com/api/v1/rate_we_buy", function(data) {
                                price = data.objects[4].rate;
                                console.log(data.objects[4].pair)
                                price = price * 100;
                                console.log("price retrieved from ETHUSD datafeed: " + price);
                                datafeed.sendPrice(id, price, {
                                    gas: 4000000
                                });
                            });
                        }
                        else {
                            $.getJSON("https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quotes%20where%20symbol%20in%20(%22" + tokenSymbol +
                                "%22)&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=",
                                function(data) {
                                    price = data.query.results.quote.LastTradePriceOnly;
                                    price = price * 100;
                                    rate = data.query.results.quote.LastTradePriceOnly;
                                    console.log("price retrieved from datafeed in penny: " + price);
                                    datafeed.sendPrice(id, price, {
                                        gas: 4000000
                                    });
                                });
                        }
                    }
                });
</script>
</body>
</html>
