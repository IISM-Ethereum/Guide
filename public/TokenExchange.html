<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css">
    <script src="scripts/web3/dist/web3.js"></script>
    <script src="scripts/jquery/dist/jquery.js"></script>
    <script>
        web3 = new Web3();
        web3.setProvider(new web3.providers.HttpProvider("http://localhost:8545"));
        web3.eth.defaultAccount = web3.eth.coinbase;
        var etherexContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"sender","type":"address"},{"name":"value","type":"uint256"}],"name":"check_fees","outputs":[{"name":"rv","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address"}],"name":"settoken","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"next_market_id","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address"}],"name":"add_market","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"amount","type":"uint256"},{"name":"price","type":"uint256"},{"name":"market_id","type":"uint256"}],"name":"buy","outputs":[{"name":"rv","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"prev","outputs":[{"name":"","type":"bytes32"}],"type":"function"},{"constant":false,"inputs":[{"name":"trade_id","type":"bytes32"},{"name":"market_id","type":"uint256"}],"name":"remove_trade","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"next","outputs":[{"name":"","type":"bytes32"}],"type":"function"},{"constant":false,"inputs":[{"name":"_typ","type":"bytes32"},{"name":"_amount","type":"uint256"},{"name":"_price","type":"uint256"},{"name":"_market_id","type":"uint256"}],"name":"save_trade","outputs":[{"name":"rv","type":"bytes32"}],"type":"function"},{"constant":true,"inputs":[],"name":"testaddress","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"a","type":"uint256"},{"name":"b","type":"uint256"}],"name":"min","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"transferFrom","outputs":[{"name":"rv","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"fees","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"id","outputs":[{"name":"","type":"bytes32"}],"type":"function"},{"constant":false,"inputs":[{"name":"market_id","type":"uint256"}],"name":"show_orderbook","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"amount","type":"uint256"},{"name":"price","type":"uint256"},{"name":"market_id","type":"uint256"}],"name":"check_trade","outputs":[{"name":"rv","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"amount","type":"uint256"},{"name":"price","type":"uint256"},{"name":"market_id","type":"uint256"}],"name":"sell","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"market_id","type":"uint256"}],"name":"trade","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"test_return","outputs":[{"name":"rv","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"amount","type":"uint256"},{"name":"market_id","type":"uint256"}],"name":"deposit","outputs":[{"name":"rv","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"test","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"token","outputs":[{"name":"","type":"address"}],"type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"typ","type":"bytes32"},{"indexed":false,"name":"price","type":"uint256"},{"indexed":false,"name":"amount","type":"uint256"}],"name":"orderBookEntry","type":"event"}]);
        var etherex = etherexContract.at("0x6d5103549d487478faaba2495877045e74085703");
        web3.eth.defaultAccount = web3.eth.accounts[0];


        var OrderBookEntry = etherex.orderBookEntry();
        OrderBookEntry.watch(function(e, r) {
            var typ = hex2a(r.args.typ);
            var price = r.args.price.toNumber();
            var amount = r.args.amount.toNumber();
            createTableRow(typ,amount,price);
        });

        function createTableRow(typ, _amount, _price) {
            if (typ == "ASK") {
                var table = document.getElementById("AskOrders");
            } else {
                var table = document.getElementById("BidOrders");
            }

            var tr = document.createElement('tr');

            var typtd = document.createElement('td');
            var amounttd = document.createElement('td');
            var pricetd = document.createElement('td');

            typtd.appendChild(document.createTextNode(typ))
            amounttd.appendChild(document.createTextNode(_amount));
            pricetd.appendChild(document.createTextNode(_price));

            tr.appendChild(typtd);
            tr.appendChild(pricetd);
            tr.appendChild(amounttd);


            table.appendChild(tr);
        };

        function hex2a(hexx) {
            var hex = hexx.toString(); //force conversion
            var str = '';
            for (var i = 2; i < hex.length; i += 2) {
                if (parseInt(hex.substr(i, 2)) != 0) {
                    str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
                }
            }
            return str;
        }

        function appendValueToDepotCookie(cookieName, value) {
            var x = getCookie(cookieName);
            x = x.split(",");
            x += "," + value;
            setCookie(cookieName, x, 100);
        }

        function getValuesFromCookie(cookieName) {
            var x = getCookie(cookieName);
            x = x.split(",");
            console.log(x);
            return x;
        }

        function contains(a, obj) {
            for (var i = 0; i < a.length; i++) {
                if (a[i] === obj) {
                    return true;
                }
            }
            return false;
        }

        function setCookie(cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            var expires = "expires=" + d.toUTCString();
            document.cookie = cname + "=" + cvalue + "; " + expires;
        }


        function getCookie(cname) {
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        /*$("document").ready(function() {
        }); */

        function getOrderBook(){
          var market_id = +document.getElementById("market_id").value;
          etherex.show_orderbook(market_id, {gas:400000});    // parameter market_id // TODO:
        }

        // todo: event was die market id rausgibt und den namen des token
        function addMarket() {
          var addr = document.getElementById("token_address").value;
          etherex.add_market(addr,{gas:4000000});
        }
        // todo: die input daten reinholen
        function buyToken() {

          etherex.buy(amount, price, market_id)
        }

        function sellToken() {

          etherex.sell(amunt, price, market_id)
        }

        // todo: tabelle mit allen token und market_ids
    </script>

</head>

<body>
    <h1>The Decentralised Stock Exchange</h1>
    <div id="Navi">
        <ul>
          <li><a href="/DollarExchange.html">Buy/Sell Bytedollar</a></li>
          <li><a href="/StockExchange.html">Stock Exchange</a></li>
          <li><a href="/Accounts.html">Accounts</a></li>
          <li><a href="/TokenExchange.html">Token Exchange</a></li>
          <li><a href="/Contact.html">Contact</a></li>
        </ul>
    </div>
    <table id="tableMarket">
        <tr id="trMarket">
            <td>
                <div id="OrderBookDiv">
                    <input type="button" onclick="getOrderBook()" value="Get Orderbook" />
                    <input type="number" min="0" id="market_id">
                </div>
            </td>
            <td>
                <div id="AddMarketDiv">
                  <input type="button" onclick="addMarket()" value="Add Token" />
                  <input type="text" min="0" id="token_address">
                </div>
            </td>
        </tr>
    </table>
    <div id="BidOrdersDiv">
        <table id="BidOrders">
            <tr>
                <th>Order-Type</th>
                <th>Price</th>
                <th>Volume</th>
            </tr>
        </table>
    </div>
    <div id="AskOrdersDiv">
        <table id="AskOrders">
          <tr>
              <th>Order-Type</th>
              <th>Price</th>
              <th>Volume</th>
          </tr>
        </table>
    </div>

    <table id="tableBuySellStock">
        <tr id="buysellTR">
            <td>
                <div id="buyStock">
                  price/volume:
                    <br>
                    <input type="number" min="0" id="TokenBuyPrice" value="price">
                    <br>
                    <input type="number" min="0" id="TokenBuyAmount" value="volume">
                    <br>
                    <input type="button" onclick="buyToken()" value="Submit Buy Order" />
                </div>
            </td>
            <td>
                <div id="sellStock">
                    price/volume:
                    <br>
                    <input type="number" min="0" id="TokenSellPrice" value="price">
                    <br>
                    <input type="number" min="0" id="TokenSellAmount" value="volume">
                    <br>
                    <input type="button" onclick="sellToken()" value="Submit Sell Order" />
                </div>
            </td>
        </tr>
    </table>

</body>
